<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dechová cvičení – volný rytmus / 4–2–6 / CO₂ hold / Box</title>
  <style>
    /* === Theme variables === */
    :root{
      --bg:#f0f4f8;
      --fg:#333;
      --box-bg:#fff;
      --primary:#0077cc;
      --border-radius:12px;
      --muted:#94a3b8;
    }
    body.dark{
      --bg:#111827;
      --fg:#e5e7eb;
      --box-bg:#1f2937;
      --primary:#3b82f6;
      --muted:#64748b;
    }

    /* === Base layout === */
    body{
      font-family:system-ui,sans-serif;
      background:var(--bg);
      color:var(--fg);
      margin:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      min-height:100vh;
      padding-top:1.25rem;
      box-sizing:border-box;
      transition:background .3s,color .3s;
    }
    h1{margin:0 0 .5rem;text-align:center;line-height:1.2}

    /* === Tabs === */
    .tabs{display:flex;gap:.5rem;margin:.25rem 0 1rem;flex-wrap:wrap;justify-content:center}
    .tab{padding:.35rem .8rem;border:2px solid var(--primary);background:transparent;color:var(--primary);
         border-radius:999px;cursor:pointer;font-size:.95rem}
    .tab[aria-selected="true"]{background:var(--primary);color:#fff}

    /* === Breathing box === */
    .box{position:relative;width:240px;height:240px;border:4px solid var(--primary);border-radius:var(--border-radius);display:flex;align-items:center;justify-content:center;margin-bottom:1rem;overflow:hidden;background:var(--box-bg);transition:background .3s,border-color .3s}
    #stepText{font-size:1.5rem;font-weight:700;color:var(--primary);z-index:1;transition:color .3s;text-align:center;padding:0 .5rem}
    .timer-bar{position:absolute;background:var(--primary);pointer-events:none;transition:background .3s;opacity:0.9}

    /* === Controls === */
    .controls{display:flex;flex-wrap:wrap;align-items:center;gap:.6rem 1rem;margin-bottom:.85rem;justify-content:center}
    .control{display:flex;align-items:center;gap:.5rem}
    .control label{font-size:.95rem}
    .control input{width:5rem;padding:.35rem .45rem;font-size:1rem;border:1px solid #cbd5e1;border-radius:6px;text-align:center;background:var(--box-bg);color:var(--fg)}
    .hint{font-size:.85rem;color:var(--muted);margin-top:-.3rem;margin-bottom:.5rem;text-align:center}

    /* === Progress / status === */
    .status{min-height:28px;margin:.25rem 0 .75rem;display:flex;align-items:center;justify-content:center;gap:.6rem;flex-wrap:wrap}
    .progress{display:flex;gap:.45rem;flex-wrap:wrap;justify-content:center}
    .dot{width:22px;height:22px;border-radius:50%;border:2px solid var(--primary);transition:background .3s,border-color .3s}
    .dot.done{background:var(--primary)}
    .timebox{font-variant-numeric:tabular-nums;font-weight:600}
    .timebar{position:relative;width:260px;height:8px;border-radius:999px;background:#cbd5e1;overflow:hidden}
    .timebar-inner{position:absolute;left:0;top:0;height:100%;width:0;background:var(--primary)}

    /* === Buttons === */
    .actions{display:flex;gap:.7rem;margin-bottom:2rem}
    button{padding:.6rem 1.4rem;font-size:1rem;border:none;background:var(--primary);color:#fff;border-radius:8px;cursor:pointer;transition:background .3s}
    button:disabled{opacity:.6;cursor:default}

    /* === Theme toggle === */
    .theme-toggle{position:fixed;left:1rem;bottom:1rem;display:flex;align-items:center;gap:.45rem;font-size:.9rem;user-select:none;z-index:10}
    .theme-toggle input{position:absolute;opacity:0;width:0;height:0}
    .slider{position:relative;width:46px;height:24px;border:2px solid var(--primary);border-radius:24px;background:var(--box-bg);cursor:pointer;transition:background .3s,border-color .3s}
    .slider::before{content:"";position:absolute;width:18px;height:18px;border-radius:50%;background:var(--primary);top:1px;left:1px;transition:transform .3s,background .3s}
    input:checked + .slider{background:var(--primary)}
    input:checked + .slider::before{transform:translateX(22px);background:var(--box-bg)}

    /* === Mobile tweaks === */
    @media(max-width:480px){
      .box{width:200px;height:200px}
      #stepText{font-size:1.25rem}
      .control input{width:4.2rem;font-size:.95rem}
      .timebar{width:220px}
      h1{font-size:1.2rem}
    }

    /* === Timer bar animations === */
    @keyframes growX{from{width:0}to{width:100%}}
    @keyframes growY{from{height:0}to{height:100%}}
  </style>
</head>
<body>
  <h1>Dechová cvičení</h1>

  <!-- Tabs -->
  <div class="tabs" role="tablist" aria-label="Cvičení">
    <button class="tab" role="tab" data-id="free_timer" aria-selected="true">Volný rytmus (čas)</button>
    <button class="tab" role="tab" data-id="relax_4_2_6" aria-selected="false">Relaxační 4–2–6</button>
    <button class="tab" role="tab" data-id="co2_hold" aria-selected="false">CO₂ hold</button>
    <button class="tab" role="tab" data-id="box" aria-selected="false">Box</button>
  </div>

  <div class="box">
    <span id="stepText" aria-live="polite" role="status">Připrav se</span>
    <div class="timer-bar" id="bar"></div>
  </div>

  <!-- Dynamic controls will render here -->
  <div class="controls" id="controls"></div>
  <div class="hint" id="hint"></div>

  <!-- Status / progress -->
  <div class="status" id="status"></div>

  <div class="actions">
    <button id="startBtn">Spustit</button>
    <button id="resetBtn">Reset</button>
  </div>

  <label class="theme-toggle" title="Přepnout světlý/tmavý režim">
    <input type="checkbox" id="themeToggle" />
    <span class="slider"></span>
    <span>Tmavý&nbsp;režim</span>
  </label>

  <script>
    // Elements
    const stepText   = document.getElementById('stepText');
    const bar        = document.getElementById('bar');
    const controlsEl = document.getElementById('controls');
    const hintEl     = document.getElementById('hint');
    const statusEl   = document.getElementById('status');
    const startBtn   = document.getElementById('startBtn');
    const resetBtn   = document.getElementById('resetBtn');
    const themeToggle= document.getElementById('themeToggle');
    const tabButtons = document.querySelectorAll('.tab');

    // --- Beeps per type
    const BEEP = { inhale:440, hold:520, exhale:392, ventilate:480, pause:480 };

    // --- Exercises config
    const exercises = {
      free_timer: {
        name: 'Volný rytmus (čas)',
        mode: 'timer',
        ui: [
          { id:'inhale', label:'Nádech (s)', type:'number', min:0.5, step:0.1, default:4 },
          { id:'exhale', label:'Výdech (s)', type:'number', min:0.5, step:0.1, default:4 },
          { id:'minutes', label:'Doba cvičení (min)', type:'number', min:1, step:1, default:5 }
        ],
        hint: 'Střídá nádech a výdech až do vypršení zadané doby.',
        buildTimeline(params){
          const inh = Math.max(0.5, +params.inhale||4);
          const exh = Math.max(0.5, +params.exhale||4);
          const total = Math.max(1, +params.minutes||5) * 60;
          const steps=[]; let t=0; let flip=true; // true=inhale, false=exhale
          while(t < total - 1e-6){
            const dur = Math.min(flip?inh:exh, total - t);
            steps.push({ label: flip?'Nádech':'Výdech', type: flip?'inhale':'exhale', dur });
            t += dur; flip = !flip;
          }
          return { steps, totalSec: total, meta: { } };
        }
      },
      relax_4_2_6: {
        name: 'Relaxační 4–2–6',
        mode: 'series',
        ui: [
          { id:'target', label:'Cílové série', type:'number', min:1, step:1, default:4 },
          { id:'base', label:'Délka kroku (s)', type:'number', min:0.5, step:0.1, default:1 }
        ],
        hint: 'Sekvence 4× nádech, 2× zadrž, 6× výdech, opakovaně po počet sérií.',
        buildTimeline(params){
          const target = Math.max(1, Math.floor(+params.target||4));
          const base = Math.max(0.5, +params.base||1);
          const mult = [4,2,6];
          const labels = ['Nádech','Zadrž dech','Výdech'];
          const types  = ['inhale','hold','exhale'];
          const steps=[]; const cycleEnds=[];
          for(let s=0;s<target;s++){
            for(let i=0;i<mult.length;i++){
              steps.push({ label: labels[i], type: types[i], dur: mult[i]*base });
            }
            cycleEnds.push(steps.length-1); // index konce serie
          }
          const totalSec = steps.reduce((a,b)=>a+b.dur,0);
          return { steps, totalSec, meta:{ cycleEnds, target } };
        }
      },
      co2_hold: {
        name: 'CO₂ hold',
        mode: 'series',
        ui: [
          { id:'target', label:'Cílové série', type:'number', min:1, step:1, default:8 },
          { id:'inhale', label:'Nádech (s)', type:'number', min:0.5, step:0.5, default:2 },
          { id:'exhale', label:'Výdech vše ven (s)', type:'number', min:1, step:1, default:10 },
          { id:'hold',   label:'Zadržení (s)', type:'number', min:5, step:1, default:20 },
          { id:'pause',  label:'Pauza (s)', type:'number', min:5, step:5, default:30 }
        ],
        hint: 'Sekvence: nádech (fix), výdech vše ven (fix), zadržení (nastavitelné, výchozí 20 s), pauza (nastavitelná, výchozí 30 s).',
        buildTimeline(params){
          const target = Math.max(1, Math.floor(+params.target||8));
          const inh = Math.max(0.5, +params.inhale||2);
          const exh = Math.max(1, +params.exhale||10);
          const hold= Math.max(5, +params.hold||20);
          const pause= Math.max(5, +params.pause||30);
          const labels=['Nádech','Výdech vše ven','Zadržení','Pauza'];
          const types =['inhale','exhale','hold','pause'];
          const steps=[]; const cycleEnds=[];
          for(let s=0;s<target;s++){
            [inh,exh,hold,pause].forEach((dur,i)=>{ steps.push({ label: labels[i], type: types[i], dur }); });
            cycleEnds.push(steps.length-1);
          }
          const totalSec = steps.reduce((a,b)=>a+b.dur,0);
          return { steps, totalSec, meta:{ cycleEnds, target } };
        }
      },
      box: {
        name: 'Box',
        mode: 'series',
        ui: [
          { id:'target', label:'Cílové série', type:'number', min:1, step:1, default:4 },
          { id:'base', label:'Délka kroku (s)', type:'number', min:0.5, step:0.1, default:4 }
        ],
        hint: 'Klasický box: Nádech – Zadrž – Výdech – Zadrž (všechny fáze stejně dlouhé).',
        buildTimeline(params){
          const target = Math.max(1, Math.floor(+params.target||4));
          const base = Math.max(0.5, +params.base||4);
          const labels = ['Nádech','Zadrž dech','Výdech','Zadrž dech'];
          const types  = ['inhale','hold','exhale','hold'];
          const steps=[]; const cycleEnds=[];
          for(let s=0;s<target;s++){
            for(let i=0;i<labels.length;i++){
              steps.push({ label: labels[i], type: types[i], dur: base });
            }
            cycleEnds.push(steps.length-1);
          }
          const totalSec = steps.reduce((a,b)=>a+b.dur,0);
          return { steps, totalSec, meta:{ cycleEnds, target } };
        }
      }
    };

    // --- State
    let exId = 'free_timer';
    let timeline = []; // {label, type, dur}
    let meta = {};     // extra indices etc.
    let totalSec = 0;  // planned total
    let stepIdx = -1;
    let stepDeadline = 0; // epoch ms when step ends
    let t0 = 0;           // epoch ms when session started
    let timerId = null;
    let tickId = null;    // UI ticker
    let audioCtx = null;

    // --- Audio beep
    function beep(freq, dur=200){
      try{
        if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type='sine';
        osc.frequency.value=freq;
        osc.connect(gain); gain.connect(audioCtx.destination);
        const t = audioCtx.currentTime;
        gain.gain.setValueAtTime(0.0001,t);
        gain.gain.exponentialRampToValueAtTime(0.25,t+0.02);
        osc.start(t);
        gain.gain.exponentialRampToValueAtTime(0.0001,t+dur/1000);
        osc.stop(t+dur/1000+0.05);
      }catch(e){}
    }

    // --- Theme
    function applyTheme(initial=false){
      if(initial){
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.body.classList.toggle('dark', prefersDark);
        themeToggle.checked = prefersDark;
      } else {
        document.body.classList.toggle('dark', themeToggle.checked);
      }
    }

    // --- Controls rendering
    function renderControls(){
      controlsEl.innerHTML='';
      const { ui, hint } = exercises[exId];
      ui.forEach(def=>{
        const wrap = document.createElement('div'); wrap.className='control';
        const lab = document.createElement('label'); lab.htmlFor = def.id; lab.textContent = def.label;
        const inp = document.createElement('input');
        inp.id=def.id; inp.type=def.type||'number';
        if(def.min!=null) inp.min=def.min;
        if(def.step!=null) inp.step=def.step;
        inp.value = def.default;
        wrap.appendChild(lab); wrap.appendChild(inp);
        controlsEl.appendChild(wrap);
      });
      hintEl.textContent = hint || '';
      renderStatusIdle();
    }

    function readParams(){
      const p={};
      (exercises[exId].ui||[]).forEach(def=>{
        const el = document.getElementById(def.id);
        if(!el) return;
        p[def.id] = el.type==='number' ? +el.value : el.value;
      });
      return p;
    }

    // --- Status / Progress rendering
    function clearStatus(){ statusEl.innerHTML=''; }

    function renderSeriesDots(n){
      const wrap = document.createElement('div'); wrap.className='progress';
      for(let i=0;i<n;i++){
        const d=document.createElement('div'); d.className='dot'; wrap.appendChild(d);
      }
      statusEl.appendChild(wrap);
    }

    function markSeriesProgress(completed){
      const dots = statusEl.querySelectorAll('.dot');
      dots.forEach((d,i)=>{ d.classList.toggle('done', i < completed); });
    }

    function renderTimer(total){
      const tb = document.createElement('div'); tb.className='timebar';
      const inner = document.createElement('div'); inner.className='timebar-inner'; inner.id='timebarInner';
      inner.style.width = '0%';
      tb.appendChild(inner);
      const txt = document.createElement('div'); txt.className='timebox'; txt.id='timebox'; txt.textContent = fmtTime(total);
      statusEl.appendChild(txt); statusEl.appendChild(tb);
    }

    function updateTimerUI(){
      if(!t0 || !totalSec) return;
      const now = Date.now();
      const elapsed = Math.max(0, (now - t0)/1000);
      const remain = Math.max(0, totalSec - elapsed);
      const inner = document.getElementById('timebarInner');
      const txt = document.getElementById('timebox');
      if(inner){ inner.style.width = `${Math.min(100, (elapsed/totalSec)*100)}%`; }
      if(txt){ txt.textContent = fmtTime(remain); }
    }

    function renderTableRounds(n){
      const label = document.createElement('div'); label.className='timebox'; label.id='roundbox'; label.textContent = `Kolo 0/${n}`;
      statusEl.appendChild(label);
      renderSeriesDots(n);
    }

    function updateRoundUI(roundDone, rounds){
      const box = document.getElementById('roundbox');
      if(box) box.textContent = `Kolo ${Math.min(roundDone, rounds)}/${rounds}`;
      markSeriesProgress(roundDone);
    }

    function renderStatusIdle(){
      clearStatus();
      const ex = exercises[exId];
      if(ex.mode==='series'){
        const targetInp = document.getElementById('target');
        const target = targetInp ? Math.max(1, Math.floor(+targetInp.value||1)) : 1;
        renderSeriesDots(target);
      } else if(ex.mode==='timer'){
        const mins = document.getElementById('minutes');
        const total = (mins? +mins.value||5 : 5)*60;
        renderTimer(total);
      } else if(ex.mode==='table'){
        const rounds = Math.max(1, Math.floor(+document.getElementById('rounds')?.value||8));
        renderTableRounds(rounds);
      }
    }

    // --- Drawing / animation per step type
    function drawBar(step){
      const dur = `${Math.max(0.1, step.dur)}s`;
      // fully reset and force reflow so animations always restart
      bar.style.animation='none';
      bar.style.transform='none';
      bar.style.top='auto'; bar.style.bottom='auto'; bar.style.left='auto'; bar.style.right='auto';
      bar.style.width='4px'; bar.style.height='4px';
      void bar.offsetWidth; // reflow to reliably restart CSS animation

      switch(step.type){
        case 'inhale': // bottom edge → right
          bar.style.bottom='0'; bar.style.left='0'; bar.style.height='4px'; bar.style.width='0';
          bar.style.animation=`growX ${dur} linear forwards`;
          break;
        case 'exhale': // top edge → left (mirror)
          bar.style.top='0'; bar.style.right='0'; bar.style.height='4px'; bar.style.width='0';
          bar.style.transform='scaleX(-1)';
          bar.style.animation=`growX ${dur} linear forwards`;
          break;
        case 'hold': // fill up inside (height from bottom)
          bar.style.left='0'; bar.style.bottom='0'; bar.style.width='100%'; bar.style.height='0';
          bar.style.animation=`growY ${dur} linear forwards`;
          break;
        case 'ventilate': // right edge ↑
        case 'pause':
          bar.style.right='0'; bar.style.bottom='0'; bar.style.width='4px'; bar.style.height='0';
          bar.style.animation=`growY ${dur} linear forwards`;
          break;
      }
    }

    // --- Helpers
    function fmtTime(sec){
      sec = Math.max(0, Math.round(sec));
      const m = Math.floor(sec/60).toString();
      const s = (sec%60).toString().padStart(2,'0');
      return `${m}:${s}`;
    }

    function scheduleNext(){
      clearTimeout(timerId); timerId=null;
      const step = timeline[stepIdx];
      if(!step){ stopCycle(); return; }
      stepDeadline = Date.now() + step.dur*1000;
      stepText.textContent = step.label;
      drawBar(step);
      beep(BEEP[step.type]||440);
      timerId = setTimeout(()=>{ advance(); }, step.dur*1000);
    }

    function advance(){
      stepIdx++;
      if(stepIdx >= timeline.length){ stopCycle(); return; }

      // Update progress meta
      const ex = exercises[exId];
      if(ex.mode==='series' && meta.cycleEnds){
        const done = meta.cycleEnds.filter(i => i < stepIdx).length;
        markSeriesProgress(done);
      }
      if(ex.mode==='table' && meta.roundEnds){
        const rounds = meta.rounds;
        const done = meta.roundEnds.filter(i => i < stepIdx).length;
        updateRoundUI(done, rounds);
      }

      scheduleNext();
    }

    function startCycle(){
      if(startBtn.disabled) return;
      const { buildTimeline, mode } = exercises[exId];
      const params = readParams();
      const built = buildTimeline(params);
      timeline = built.steps; totalSec = built.totalSec; meta = built.meta||{};
      if(!timeline.length){ return; }
      // Reset UI
      stepIdx = 0; t0 = Date.now();
      startBtn.disabled=true;
      // Render status widgets for this run
      clearStatus();
      if(mode==='series'){
        renderSeriesDots(meta.target||1);
      } else if(mode==='timer'){
        renderTimer(totalSec); updateTimerUI();
      } else if(mode==='table'){
        renderTableRounds(meta.rounds||1);
      }
      // First step
      stepIdx = -1; advance();
      // Ticker for time-based UIs
      clearInterval(tickId);
      if(mode!=='series'){
        tickId = setInterval(updateTimerUI, 250);
      }
    }

    function stopCycle(){
      clearTimeout(timerId); timerId=null;
      clearInterval(tickId); tickId=null;
      bar.style.animation='none';
      stepText.textContent='Hotovo!';
      startBtn.disabled=false;
    }

    function resetCycle(){
      clearTimeout(timerId); timerId=null;
      clearInterval(tickId); tickId=null;
      startBtn.disabled=false;
      bar.style.animation='none';
      stepText.textContent='Připrav se';
      t0=0; stepIdx=-1; timeline=[]; meta={}; totalSec=0;
      renderStatusIdle();
    }

    // --- Tabs
    function setExercise(id){
      if(!exercises[id]) return;
      exId = id;
      tabButtons.forEach(btn=>btn.setAttribute('aria-selected', btn.dataset.id===id ? 'true':'false'));
      resetCycle();
      renderControls();
    }

    // --- Init
    applyTheme(true);
    renderControls();
    renderStatusIdle();

    // --- Events
    themeToggle.addEventListener('change',()=>applyTheme());
    startBtn.addEventListener('click', startCycle);
    resetBtn.addEventListener('click', resetCycle);
    tabButtons.forEach(btn=> btn.addEventListener('click', ()=> setExercise(btn.dataset.id)) );

    // When inputs change, refresh idle status preview (time/dots)
    controlsEl.addEventListener('input', ()=>{ if(!startBtn.disabled) renderStatusIdle(); });
  </script>
</body>
</html>

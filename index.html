<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DECH(ovka)</title>
<style>
  /* === Theme variables === */
  :root{
    --bg:#ffffff;                /* pevné bílé pozadí v light */
    --fg:#1f2937;
    --box-bg:#f8fafc;            /* FIX: světlejší box v light */
    --primary:#0a7bd6;
    --ink:#0b1220;
    --radius:14px;
    --muted:#64748b;

    --bg-inhale:#e0f2fe;
    --bg-exhale:#ffe4e6;
    --bg-hold:#ecfccb;           /* overlay „zadržení“ */
    --bg-pause:#f5f3ff;
    --bg-opa:.8;

    --glass-bg:rgba(255,255,255,.16);
    --glass-border:rgba(0,0,0,.08);
    --glass-shadow:rgba(2,8,23,.12);

    --tabs-bg:rgba(255,255,255,.7);
    --tab-inactive-bg:rgba(255,255,255,.65);
    --tab-inactive-fg:#0b1b2e;

    --field-bg:#ffffff;
    --field-border:#cbd5e1;
    --label:#475569;
    --focus:#60a5fa;

    --btn-outline-bg: rgba(10,123,214,.08);
    --btn-pill-bg:    rgba(10,123,214,.10);
  }
  body.dark{
    --bg:#000000;                /* pevné černé pozadí v dark */
    --fg:#e5e7eb;
    --box-bg:#111827;
    --primary:#3b82f6;
    --ink:#dbeafe;
    --muted:#a7b4c8;

    --bg-inhale:#2b7be4;
    --bg-exhale:#e24f76;
    --bg-hold:#3fbf6b;
    --bg-pause:#9b7df4;
    --bg-opa:1;

    --glass-bg:rgba(17,24,39,.50);
    --glass-border:rgba(148,163,184,.30);
    --glass-shadow:rgba(0,0,0,.40);

    --tabs-bg:rgba(15,23,42,.55);
    --tab-inactive-bg:rgba(255,255,255,.10);
    --tab-inactive-fg:#cbd5e1;

    --field-bg:#0b1220;
    --field-border:#3a4a62;
    --label:#cbd5e1;
    --focus:#60a5fa;

    --btn-outline-bg: rgba(59,130,246,.22);
    --btn-pill-bg:    rgba(59,130,246,.24);
  }

  /* === Base === */
  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh; background:var(--bg); color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    transition:background .4s ease,color .3s ease; overflow-x:hidden;
  }
  .wrap{display:flex;flex-direction:column;align-items:center;gap:.9rem;padding:1.25rem 1rem}
  body.onboard .wrap{ filter: blur(8px) saturate(.9); pointer-events:none; }
  h1{margin:.2rem 0 .25rem;text-align:center}

  /* === Animated bg (crossfade layers) === */
  .bg-anim{
    position:fixed; inset:0; z-index:-1; pointer-events:none;
    filter:blur(50px); opacity:0;
    transition:opacity 600ms ease-in-out, transform 12s ease-in-out;
  }
  .bg-anim.float{ animation:float 16s ease-in-out infinite alternate; }
  @keyframes float{ from{transform:scale(1)} to{transform:scale(1.04)} }
  body.dark .bg-anim{ mix-blend-mode:screen; }
  body.dim .bg-anim { opacity: .28 !important; }

   /* === Tabs scroller + fades === */
.tabs-wrap{position:relative;width:min(1000px,95vw); margin:0 auto; padding-bottom:1.2rem;} /* FIX: centrum + místo pro hint */
.tabs{
  display:flex;
  gap:.4rem;
  padding:.35rem;
  border-radius:999px;
  background:var(--tabs-bg);
  border:1px solid var(--glass-border);
  -webkit-backdrop-filter: blur(8px);
  backdrop-filter: blur(8px);
  white-space:nowrap;
  justify-content:center; /* centrování na PC */
}

/* na mobilech vrátíme scroll */
@media (max-width: 768px){
  .tabs{
    overflow-x:auto;
    justify-content:flex-start;
    scroll-behavior:smooth;
  }
}
  .tab{
    padding:.45rem 1rem; border-radius:999px; border:1px solid transparent;
    background:var(--tab-inactive-bg); color:var(--tab-inactive-fg);
    cursor:pointer; font-size:.95rem; font-weight:600;
    transition:background .2s,color .2s,box-shadow .2s,border-color .2s;
  }
  .tab[aria-selected="true"]{
    background:var(--primary); color:#fff; font-weight:800;
    box-shadow:0 2px 10px rgba(2,8,23,.18), inset 0 0 0 1px rgba(255,255,255,.18);
  }
  .tab:focus-visible{ outline:2px solid var(--focus); outline-offset:2px; }

  /* FIX: výraznější a vždy nad záložkami + barva navazuje na pozadí stránky */
  .tabs-fade{
    position:absolute; top:0; bottom:0; width:28px; pointer-events:none; opacity:0; transition:opacity .2s;
    z-index:2;
    background:linear-gradient(to right, rgba(0,0,0,0) 0%, var(--bg) 90%);
    border-radius:999px;
  }
  body.dark .tabs-fade{
    background:linear-gradient(to right, rgba(0,0,0,0) 0%, #000 90%);
  }
.tabs-fade.left{ display:none !important; }  /* vypnuto vlevo */
.tabs-fade.right{ right:-2px; }
.tabs-fade.show{ opacity:1; }


  /* FIX: hint jen šipka a pod záložkami, aby nic nepřekrývala */
.tabs-hint{
  position:absolute;
  right:8px;
  top:50%;
  transform:translateY(-50%);
  font-size:1.2rem;
  color:#fff; /* kontrastní bílá */
  background:rgba(0,0,0,0.35); /* poloprůhledný podklad */
  padding:0.15rem 0.45rem;
  border-radius:999px;
  pointer-events:none;
  opacity:0;
  transition:opacity .3s;
  z-index:3; /* nad kartami */
}
.tabs-hint.show{opacity:1}

  /* === Info card === */
  .info-card{
    width:min(920px, 95vw); padding:.9rem 1rem .8rem; border-radius:16px;
    background:var(--glass-bg); border:1px solid var(--glass-border);
    -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px);
    box-shadow:0 8px 24px var(--glass-shadow);
  }
  .info-header{display:flex;align-items:baseline;gap:.6rem;flex-wrap:wrap;justify-content:center}
  .info-title{font-weight:800;letter-spacing:.2px}
  .info-sub{color:var(--muted);font-size:.95rem}
  .info-brief{margin:.45rem auto .35rem;max-width:70ch;text-align:center;line-height:1.35}
  .info-actions{display:flex;gap:.5rem;justify-content:center;flex-wrap:wrap}
  .link-btn{background:var(--btn-pill-bg);border:1px solid var(--primary);color:var(--fg);
    padding:.28rem .8rem;border-radius:999px;cursor:pointer;font-size:.92rem;font-weight:600}

  .info-details{display:none;margin-top:.5rem}
  .info-details.show{display:block}
  .info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.7rem}
  .info-block{background:rgba(255,255,255,.06);border:1px dashed var(--glass-border);border-radius:12px;padding:.6rem .7rem}
  body.dark .info-block{background:rgba(0,0,0,.15)}
  .info-block h4{margin:.1rem 0 .35rem;font-size:1rem}
  .info-list{margin:.1rem 0 .1rem;padding-left:1.1rem}

  /* === Box === */
  .box{
    position:relative;width:280px;height:280px;border:4px solid var(--primary);
    border-radius:var(--radius);display:flex;align-items:center;justify-content:center;
    margin:.6rem 0 .2rem;overflow:hidden;background:var(--box-bg);transition:background .3s,border-color .3s
  }
  #stepText{
    font-size:1.5rem;font-weight:800;color:var(--ink);z-index:3;text-align:center;padding:0 .5rem;
    text-shadow:0 1px 2px rgba(0,0,0,.08)
  }
  .timer-bar{position:absolute;background:var(--primary);pointer-events:none;opacity:.9;z-index:1}
  .ring{position:absolute;inset:0;pointer-events:none;z-index:2;opacity:0}
  .ring svg{width:100%;height:100%;display:block}
  .ring .path{fill:none;stroke:var(--primary);stroke-width:4px}

  /* === Controls (unified inputs) === */
  .controls{display:flex;flex-direction:column;align-items:center;gap:.55rem;margin:.5rem 0 .35rem}
  .row{display:flex;flex-wrap:wrap;gap:1rem;align-items:flex-end;justify-content:center}
  .control{display:flex;flex-direction:column;align-items:flex-start;gap:.35rem; min-width: 160px;}
  .control label{font-size:.92rem;color:var(--label)}
  .control input,.control select{
    width:180px;height:44px;padding:.35rem .6rem;font-size:1rem;
    border:1px solid var(--field-border);border-radius:10px;background:var(--field-bg);color:var(--fg);outline:none;
  }
  .control input:focus,.control select:focus{ box-shadow:0 0 0 2px var(--focus); border-color:transparent; }

  /* === Status / progress === */
  .status{min-height:30px;margin:.25rem 0 .6rem;display:flex;align-items:center;justify-content:center;gap:.6rem;flex-wrap:wrap}
  .progress{display:flex;gap:.45rem;flex-wrap:wrap;justify-content:center}
  .dot{width:22px;height:22px;border-radius:50%;border:2px solid var(--primary);transition:background .3s,border-color .3s}
  .dot.done{background:var(--primary)}
  .timebox{font-variant-numeric:tabular-nums;font-weight:700}
  .timebar{position:relative;width:300px;height:8px;border-radius:999px;background:#cbd5e1;overflow:hidden}
  .timebar-inner{position:absolute;left:0;top:0;height:100%;width:0;background:var(--primary)}

  /* === Buttons === */
  .actions{display:flex;gap:.7rem;margin:.6rem 0 1.1rem;flex-wrap:wrap;justify-content:center}
  .btn{padding:.7rem 1.2rem;font-size:1rem;border:none;border-radius:12px;cursor:pointer;transition:transform .05s ease,opacity .2s ease}
  .btn:active{transform:translateY(1px)}
  .btn:disabled{opacity:.6;cursor:default}
  .btn-primary{background:var(--primary);color:#fff}
  .btn-outline{background:var(--btn-outline-bg);border:1px solid var(--primary);color:#fff}
  body:not(.dark) .btn-outline{color:var(--primary)}
  .btn-ghost{background:transparent;border:1px solid rgba(148,163,184,.45);color:var(--fg)}

  /* === Toggles & footer === */
  .toggles{display:flex;gap:1rem;align-items:center;justify-content:center}
  .toggle{display:flex;align-items:center;gap:.45rem;font-size:.95rem}
  .toggle input{position:absolute;opacity:0;width:0;height:0}
  .slider{position:relative;width:54px;height:28px;border:2px solid var(--primary);border-radius:28px;background:var(--box-bg);cursor:pointer;transition:background .3s,border-color .3s}
  .slider::before{content:"";position:absolute;width:22px;height:22px;border-radius:50%;background:var(--primary);top:1px;left:1px;transition:transform .3s,background .3s}
  input:checked + .slider{background:var(--primary)}
  input:checked + .slider::before{transform:translateX(26px);background:var(--box-bg)}
  footer{margin:1rem 0 .25rem;color:var(--muted);font-size:.9rem}
  footer a{color:var(--primary);text-decoration:none}

  /* === Modal: Welcome onboarding === */
  .modal{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:1rem; z-index:60;
    background:rgba(0,0,0,.28);
  }
  .modal.show{display:flex}
  .sheet{
    width:min(920px, 95vw); max-height:86vh; overflow:auto;
    border-radius:18px; padding:1rem 1rem .9rem;
    background:var(--glass-bg); border:1px solid var(--glass-border);
    -webkit-backdrop-filter: blur(12px); backdrop-filter: blur(12px);
    box-shadow:0 10px 30px var(--glass-shadow); color:var(--fg);
  }
  .slides{display:grid;gap:.8rem}
  .slide{display:none}
  .slide.show{display:block}
  .dots{display:flex;gap:.35rem;justify-content:center;margin:.1rem 0}
  .dots b{width:8px;height:8px;border-radius:50%;background:#94a3b8;display:inline-block;opacity:.5}
  .dots b.active{opacity:1;background:var(--primary)}
  .sheet .foot{display:flex;justify-content:space-between;gap:.6rem;margin-top:.5rem;flex-wrap:wrap}

  /* === Mobile sticky actions === */
  @media(max-width:640px){
    .actions{
      position:fixed; left:12px; right:12px; bottom:12px; z-index:55;
      background:var(--glass-bg); -webkit-backdrop-filter: blur(14px); backdrop-filter: blur(14px);
      border:1px solid var(--glass-border); border-radius:16px; padding:.6rem;
      box-shadow:0 8px 24px var(--glass-shadow);
    }
    .wrap{padding-bottom:calc(120px + env(safe-area-inset-bottom))}
  }

  /* === Mobile sizing === */
  @media(max-width:520px){
    .box{width:240px;height:240px}
    #stepText{font-size:1.2rem}
    .control input,.control select{width:160px}
    .timebar{width:260px}
    h1{font-size:1.2rem}
    .btn{flex:1 1 auto}
  }
</style>
</head>
<body>
  <!-- animated overlay bg -->
  <div class="bg-anim float" id="bgA" aria-hidden="true"></div>
  <div class="bg-anim float" id="bgB" aria-hidden="true"></div>

  <div class="wrap" id="mainWrap">
    <h1>DECH(ovka)</h1>

    <!-- Tabs scroller with fades -->
    <div class="tabs-wrap" aria-label="Výběr cvičení">
      <div class="tabs" id="tabs" role="tablist">
        <button class="tab" role="tab" data-id="free_timer" aria-selected="true">Volná vlna</button>
        <button class="tab" role="tab" data-id="relax_4_2_6" aria-selected="false">Klid 4–2–6</button>
        <button class="tab" role="tab" data-id="co2_hold" aria-selected="false">CO₂ Reset</button>
        <button class="tab" role="tab" data-id="box" aria-selected="false">Čtverec klidu</button>
        <button class="tab" role="tab" data-id="wimhof" aria-selected="false">Energické cykly</button>
        <button class="tab" role="tab" data-id="custom" aria-selected="false">Vlastní režim</button>
      </div>
      <div class="tabs-fade left"  id="fadeL" aria-hidden="true"></div>
      <div class="tabs-fade right" id="fadeR" aria-hidden="true"></div>
      <div class="tabs-hint" id="tabsHint" aria-hidden="true" title="Posuň se doprava">→</div> <!-- FIX: jen šipka, pod záložkami -->
    </div>

    <!-- Info card -->
    <section class="info-card" id="infoCard">
      <div class="info-header">
        <div class="info-title" id="infoTitle">Volná vlna</div>
        <div class="info-sub" id="infoSub">Nastav si rytmus a plynule dýchej.</div>
      </div>
      <div class="info-brief" id="infoBrief">Zpomal, slaď nádech s výdechem a srovnej hlavu.</div>
      <div class="info-actions">
        <button class="link-btn" id="toggleDetailsBtn" aria-expanded="false" aria-controls="infoDetails">Více informací</button>
      </div>
      <div class="info-details" id="infoDetails"></div>
    </section>

    <!-- Visualizer -->
    <div class="box" aria-label="Dechový vizualizér">
      <span id="stepText" aria-live="polite" role="status">Připrav se</span>
      <div class="timer-bar" id="bar"></div>
      <div class="ring" id="ring" aria-hidden="true">
        <svg viewBox="0 0 100 100" preserveAspectRatio="none">
          <path id="ringPath" class="path" d="M2 98 H98 V2 H2 V98"/>
        </svg>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls" id="controls"></div>

    <!-- Status -->
    <div class="status" id="status"></div>

    <!-- Actions -->
    <div class="actions" id="actionsBar">
      <button id="startBtn" class="btn btn-primary">Začít</button>
      <button id="pauseBtn" class="btn btn-outline" disabled>Pauza</button>
      <button id="resetBtn" class="btn btn-ghost">Reset</button>
    </div>

    <!-- Toggles -->
    <div class="toggles">
      <label class="toggle" title="Přepnout světlý/tmavý režim">
        <input type="checkbox" id="themeToggle"/><span class="slider"></span><span>Tmavý režim</span>
      </label>
      <label class="toggle" title="Vypnout/Zapnout pípnutí">
        <input type="checkbox" id="muteToggle"/><span class="slider"></span><span>Mute</span>
      </label>
    </div>

    <footer>
      <a href="#" id="helpLink">Nápověda</a>
    </footer>
  </div>

  <!-- Welcome Onboarding -->
  <div class="modal" id="welcomeModal" role="dialog" aria-modal="true" aria-labelledby="welcomeTitle">
    <div class="sheet">
      <h3 id="welcomeTitle" style="margin:.1rem 0 .3rem">Vítej v DECH(ovka)</h3>
      <div class="slides" id="slides">
        <div class="slide show">
          <p>Aplikace pro dechová cvičení, která pomáhá zklidnit mysl, zlepšit soustředění a posílit práci s dechem.</p>
        </div>
        <div class="slide">
          <p><b>Jak začít</b></p>
          <ol>
            <li>Vyber cvičení nahoře (přejeď prstem pro více možností).</li>
            <li>Nastav délky/počet sérií podle sebe.</li>
            <li>Stiskni <b>Start</b> a řiď se animací.</li>
          </ol>
        </div>
        <div class="slide">
          <p><b>Během cvičení</b></p>
          <ul>
            <li>Animace ukazuje nádech, výdech, zadržení a pauzu.</li>
            <li>Ovládání: Start / Pauza / Reset (dole stále po ruce).</li>
            <li>Necítíš se dobře? Přeruš a dýchej přirozeně.</li>
          </ul>
        </div>
        <div class="slide">
          <p><b>Tipy & bezpečnost</b></p>
          <ul>
            <li>Cvič vsedě/vleže v klidu, nikdy ve vodě.</li>
            <li>Začni kratšími časy, postupně přidávej.</li>
            <li>V Nastavení můžeš zapnout Tmavý režim a Mute.</li>
          </ul>
        </div>
      </div>
      <div class="dots" id="dots"></div>
      <div class="foot">
        <button class="btn btn-ghost" id="skipBtn">Přeskočit</button>
        <div style="display:flex;gap:.5rem">
          <button class="btn btn-ghost" id="prevBtn" disabled>Zpět</button>
          <button class="btn btn-primary" id="nextBtn">Další</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ======= Shortcuts to DOM ======= */
const stepText = document.getElementById('stepText');
const bar      = document.getElementById('bar');
const ring     = document.getElementById('ring');
const ringPath = document.getElementById('ringPath');

const controlsEl = document.getElementById('controls');
const statusEl   = document.getElementById('status');
const startBtn   = document.getElementById('startBtn');
const pauseBtn   = document.getElementById('pauseBtn');
const resetBtn   = document.getElementById('resetBtn');
const themeToggle= document.getElementById('themeToggle');
const muteToggle = document.getElementById('muteToggle');

const tabsEl = document.getElementById('tabs');
const tabButtons = tabsEl.querySelectorAll('.tab');
const fadeL = document.getElementById('fadeL');
const fadeR = document.getElementById('fadeR');
const tabsHint = document.getElementById('tabsHint');

const infoTitle= document.getElementById('infoTitle');
const infoSub  = document.getElementById('infoSub');
const infoBrief= document.getElementById('infoBrief');
const infoDetails = document.getElementById('infoDetails');
const toggleDetailsBtn = document.getElementById('toggleDetailsBtn');

const welcomeModal = document.getElementById('welcomeModal');
const slidesEl = document.getElementById('slides');
const dotsEl = document.getElementById('dots');
const nextBtn = document.getElementById('nextBtn');
const prevBtn = document.getElementById('prevBtn');
const skipBtn = document.getElementById('skipBtn');
const helpLink = document.getElementById('helpLink');

const bgA = document.getElementById('bgA');
const bgB = document.getElementById('bgB');
let activeBg = bgA;

/* ======= Helpers & storage ======= */
const EX_ORDER = ['free_timer','relax_4_2_6','co2_hold','box','wimhof','custom'];
const TYPE_LABELS = { inhale:'Nádech', exhale:'Výdech', hold:'Zadržení', pause:'Pauza', ventilate:'Pauza' };
const BEEP = { inhale:440, hold:520, exhale:392, ventilate:480, pause:480 };

const LS_PREFIX='breath_';
const ls = {
  save(k,v){ try{ localStorage.setItem(LS_PREFIX+k, JSON.stringify(v)); }catch(e){} },
  load(k,f){ try{ const v=localStorage.getItem(LS_PREFIX+k); return v?JSON.parse(v):f; }catch(e){ return f; } }
};

/* ======= Info copy per exercise (zkráceno) ======= */
const INFO = {
  free_timer:{title:'Volná vlna',sub:'Nastav si rytmus a plynule dýchej.',brief:'Zpomal, slaď nádech s výdechem a srovnej hlavu.',
    blocks:[{h:'Co to je',items:['Střídání nádechu a výdechu v tempu, které si nastavíš.','Běží po dobu, kterou zvolíš.']},
            {h:'Proč',items:['Zklidní nervový systém.','Zlepší vnímání těla.']},
            {h:'Kdy',items:['Kdykoli během dne.']},
            {h:'Tipy & bezpečnost',items:['Dýchej pohodlně.','Začni kratší dobou.','Ovládání: Start / Pauza / Reset.']}]},
  relax_4_2_6:{title:'Klid 4–2–6',sub:'Uvolní nervový systém během pár minut.',brief:'Delší výdech aktivuje parasympatikus a uklidní tělo i mysl.',
    blocks:[{h:'Co to je',items:['4 s nádech → 2 s zadrž → 6 s výdech.','V několika sériích.']},
            {h:'Proč',items:['Snižuje stres a tep.','Pomáhá s usínáním.']},
            {h:'Kdy',items:['Večer nebo po zátěži.']},
            {h:'Tipy & bezpečnost',items:['Dýchej nosem.','Začni 3–5 sériemi.']}]},
  co2_hold:{title:'CO₂ Reset',sub:'Výdech do prázdna, držení, pauza — klid v napětí.',brief:'Zvyšuj toleranci na CO₂ a zvládni napětí klidným výdechem.',
    blocks:[{h:'Co to je',items:['Nádech → výdech „do prázdna“ → držení → pauza.','Pauza má obvodový ukazatel.']},
            {h:'Proč',items:['Zvyšuje toleranci na CO₂.','Zklidní pocit dušnosti.']},
            {h:'Kdy',items:['Trénink klidu přes den.']},
            {h:'Tipy & bezpečnost',items:['Cvič vsedě/vleže.','Nikdy ne ve vodě.']}]},
  box:{title:'Čtverec klidu',sub:'Box breathing pro soustředění a stabilitu.',brief:'Čtyři stejné kroky vyrovnají dech i soustředění.',
    blocks:[{h:'Co to je',items:['Nádech – zadrž – výdech – zadrž.','Každá fáze kreslí jednu hranu.']},
            {h:'Proč',items:['Stabilizuje dech i myšlenky.','Zlepšuje fokus.']},
            {h:'Kdy',items:['Před výkonem.']},
            {h:'Tipy & bezpečnost',items:['Začni 3–4 s na krok.']}]},
  wimhof:{title:'Energické cykly',sub:'Série dechů a držení pro energii a fokus.',brief:'Rychle nakopne bdělost — cvič vsedě/vleže, ne před spaním.',
    blocks:[{h:'Co to je',items:['Série hlubších dechů → držení po výdechu → plný nádech → krátké držení.']},
            {h:'Proč',items:['Zvedá bdělost.','Přepíná pozornost.']},
            {h:'Kdy',items:['Ráno nebo před výkonem.']} ]},
  custom:{title:'Vlastní režim',sub:'Sestav si cvičení na míru.',brief:'Poskládej si kroky a časy přesně podle sebe.',
    blocks:[{h:'Co to je',items:['Kroky: nádech, výdech, zadržení, pauza.','Nastavíš opakování sekvence.']},
            {h:'Proč',items:['Plná kontrola nad tempem.']} ]}
};

/* ======= Exercises ======= */
const exercises = {
  free_timer:{ mode:'timer',
    ui:[{id:'inhale',label:'Nádech (s)',type:'number',min:.5,step:.1,default:4},
        {id:'exhale',label:'Výdech (s)',type:'number',min:.5,step:.1,default:4},
        {id:'minutes',label:'Doba cvičení (min)',type:'number',min:1,step:1,default:5}],
    buildTimeline(p){ const inh=Math.max(.5,+p.inhale||4), ex=Math.max(.5,+p.exhale||4), total=Math.max(1,+p.minutes||5)*60;
      const steps=[]; let t=0, flip=true; while(t<total-1e-6){ const d=Math.min(flip?inh:ex,total-t); steps.push({label:flip?'Nádech':'Výdech',type:flip?'inhale':'exhale',dur:d}); t+=d; flip=!flip; }
      return {steps,totalSec:total,meta:{}}; } },
  relax_4_2_6:{ mode:'series',
    ui:[{id:'target',label:'Cílové série',type:'number',min:1,step:1,default:4}],
    buildTimeline(p){ const target=Math.max(1,Math.floor(+p.target||4)); const d=[4,2,6], t=['inhale','hold','exhale'], lab=['Nádech','Zadržení','Výdech'];
      const steps=[], ends=[]; for(let s=0;s<target;s++){ for(let i=0;i<d.length;i++) steps.push({label:lab[i],type:t[i],dur:d[i]}); ends.push(steps.length-1); }
      return {steps,totalSec:steps.reduce((a,b)=>a+b.dur,0),meta:{cycleEnds:ends,target}}; } },
  co2_hold:{ mode:'series',
    ui:[{id:'target',label:'Cílové série',type:'number',min:1,step:1,default:8},
        {id:'inhale',label:'Nádech (s)',type:'number',min:.5,step:.5,default:3},
        {id:'exhale',label:'Výdech vše ven (s)',type:'number',min:1,step:1,default:5},
        {id:'hold',label:'Zadržení (s)',type:'number',min:5,step:1,default:20},
        {id:'pause',label:'Pauza (s)',type:'number',min:5,step:5,default:30}],
    buildTimeline(p){ const target=Math.max(1,Math.floor(+p.target||8));
      const inh=Math.max(.5,+p.inhale||3), ex=Math.max(1,+p.exhale||5), hold=Math.max(5,+p.hold||20), pause=Math.max(5,+p.pause||30);
      const labs=['Nádech','Výdech vše ven','Zadržení','Pauza'], types=['inhale','exhale','hold','pause'];
      const steps=[], ends=[]; for(let s=0;s<target;s++){ [inh,ex,hold,pause].forEach((d,i)=>steps.push({label:labs[i],type:types[i],dur:d})); ends.push(steps.length-1); }
      return {steps,totalSec:steps.reduce((a,b)=>a+b.dur,0),meta:{cycleEnds:ends,target}}; } },
  box:{ mode:'series',
    ui:[{id:'target',label:'Cílové série',type:'number',min:1,step:1,default:4},
        {id:'base',label:'Délka kroku (s)',type:'number',min:.5,step:.1,default:4}],
    buildTimeline(p){ const target=Math.max(1,Math.floor(+p.target||4)), base=Math.max(.5,+p.base||4);
      const lab=['Nádech','Zadržení','Výdech','Zadržení'], types=['inhale','hold','exhale','hold'];
      const steps=[], ends=[]; for(let s=0;s<target;s++){ for(let i=0;i<4;i++) steps.push({label:lab[i],type:types[i],dur:base}); ends.push(steps.length-1); }
      return {steps,totalSec:steps.reduce((a,b)=>a+b.dur,0),meta:{cycleEnds:ends,target}}; } },
  wimhof:{ mode:'series',
    ui:[{id:'cycles',label:'Cykly',type:'number',min:1,step:1,default:3},
        {id:'breaths',label:'Dechy v cyklu',type:'number',min:10,step:1,default:30},
        {id:'tempo',label:'Sekundy / dech',type:'number',min:.8,step:.1,default:2},
        {id:'retEmpty',label:'Zadržení po výdechu (s)',type:'number',min:10,step:5,default:60},
        {id:'retFull',label:'Zadržení po plném nádechu (s)',type:'number',min:5,step:5,default:15}],
    buildTimeline(p){ const C=Math.max(1,Math.floor(+p.cycles||3)), B=Math.max(10,Math.floor(+p.breaths||30)), T=Math.max(.8,+p.tempo||2);
      const inh=T*.6, ex=T*.4, re=Math.max(5,+p.retEmpty||60), rf=Math.max(5,+p.retFull||15);
      const steps=[], ends=[]; for(let c=0;c<C;c++){ for(let b=0;b<B;b++){ steps.push({label:`Nádech (${b+1}/${B})`,type:'inhale',dur:inh}); steps.push({label:`Výdech (${b+1}/${B})`,type:'exhale',dur:ex}); }
        steps.push({label:'Zadržení po výdechu',type:'hold',dur:re}); steps.push({label:'Hluboký nádech',type:'inhale',dur:1.5}); steps.push({label:'Drž plný dech',type:'hold',dur:rf}); ends.push(steps.length-1);}
      return {steps,totalSec:steps.reduce((a,b)=>a+b.dur,0),meta:{cycleEnds:ends,target:C}}; } },
  custom:{ mode:'series',
    ui:[{id:'loops',label:'Opakování sekvence',type:'number',min:1,step:1,default:3}],
    buildTimeline(p){ const loops=Math.max(1,Math.floor(+p.loops||3)); const defs=getCustomSteps();
      const steps=[], ends=[]; for(let L=0;L<loops;L++){ for(const s of defs){ steps.push({label:TYPE_LABELS[s.type]||'Krok',type:s.type,dur:Math.max(.1,+s.dur||1)});} ends.push(steps.length-1);}
      return {steps,totalSec:steps.reduce((a,b)=>a+b.dur,0),meta:{cycleEnds:ends,target:loops}}; } }
};

/* ======= Info rendering ======= */
function renderInfo(){
  const i = INFO[exId];
  infoTitle.textContent = i.title;
  infoSub.textContent   = i.sub;
  infoBrief.textContent = i.brief;
  infoDetails.innerHTML = `
    <div class="info-grid">
      ${i.blocks.map(b=>`
        <div class="info-block">
          <h4>${b.h}</h4>
          <ul class="info-list">${b.items.map(li=>`<li>${li}</li>`).join('')}</ul>
        </div>`).join('')}
    </div>`;
  infoDetails.classList.remove('show');
  toggleDetailsBtn.setAttribute('aria-expanded','false');
  toggleDetailsBtn.textContent='Více informací';
}
toggleDetailsBtn.addEventListener('click',()=>{
  const open = infoDetails.classList.toggle('show');
  toggleDetailsBtn.setAttribute('aria-expanded', String(open));
  toggleDetailsBtn.textContent = open ? 'Méně informací' : 'Více informací';
  document.body.classList.toggle('dim', open);
});

/* ======= Background overlay ======= */
function gradientForPhase(phase){
  const c = phase==='inhale' ? 'var(--bg-inhale)'
          : phase==='exhale' ? 'var(--bg-exhale)'
          : phase==='hold'   ? 'var(--bg-hold)'
          :                    'var(--bg-pause)';
  return `radial-gradient(55% 55% at 40% 35%, ${c} 0%, ${c} 35%, transparent 75%),
          radial-gradient(45% 45% at 70% 65%, ${c} 0%, transparent 70%)`;
}
function fadeBgToPhase(phase, instant=false){
  const target = (activeBg===bgA)? bgB : bgA;
  const opa = parseFloat(getComputedStyle(document.body).getPropertyValue('--bg-opa')) || 0.8;
  target.style.background = gradientForPhase(phase);
  target.style.opacity = instant ? String(opa) : '0';
  requestAnimationFrame(()=>{
    if(!instant){ target.style.opacity = String(opa); activeBg.style.opacity='0'; }
    activeBg = target;
  });
}

/* ======= Controls & custom builder ======= */
let customSteps = ls.load('custom_steps', [{type:'inhale',dur:4},{type:'hold',dur:2},{type:'exhale',dur:4}]);

function getCustomSteps(){ return customSteps; }
function renderCustomRows(){ /* (zkráceno – generuje řádky pro vlastní kroky) */ }

function renderControls(){
  controlsEl.innerHTML='';
  const { ui } = exercises[exId];
  if(exId==='custom'){
    const top=document.createElement('div'); top.className='row';
    top.innerHTML=`<div class="control"><label for="loops">Opakování</label>
      <input id="loops" type="number" min="1" step="1" value="${ls.load('custom_loops',3)}" inputmode="numeric"></div>`;
    controlsEl.appendChild(top);
    const list=document.createElement('div'); list.id='customList'; list.className='row'; controlsEl.appendChild(list);
    renderCustomRows = function(){
      list.innerHTML='';
      customSteps.forEach((s,i)=>{
        const row=document.createElement('div'); row.className='row'; row.dataset.idx=i;
        row.innerHTML=`
          <div class="control"><label>Typ</label>
            <select class="custom-field" data-key="type">
              ${['inhale','exhale','hold','pause'].map(t=>`<option value="${t}" ${t===s.type?'selected':''}>${TYPE_LABELS[t]}</option>`).join('')}
            </select>
          </div>
          <div class="control"><label>Délka (s)</label>
            <input class="custom-field" data-key="dur" type="number" min="0.1" step="0.1" value="${s.dur}" inputmode="decimal">
          </div>
          <div class="control" style="align-items:center"><button type="button" data-action="del" class="btn btn-ghost">Smazat</button></div>`;
        list.appendChild(row);
      });
    };
    renderCustomRows();
    const addWrap=document.createElement('div'); addWrap.className='row';
    const btn=document.createElement('button'); btn.className='btn btn-outline'; btn.type='button'; btn.textContent='Přidat krok';
    btn.onclick=()=>{ customSteps.push({type:'inhale',dur:4}); ls.save('custom_steps',customSteps); renderCustomRows(); };
    addWrap.appendChild(btn); controlsEl.appendChild(addWrap);

    list.onclick=(e)=>{ const b=e.target.closest('[data-action="del"]'); if(!b) return; const idx=+b.closest('.row').dataset.idx; customSteps.splice(idx,1); ls.save('custom_steps',customSteps); renderCustomRows(); };
    list.oninput=(e)=>{ if(!e.target.classList.contains('custom-field')) return;
      const row=e.target.closest('.row'); const idx=+row.dataset.idx;
      const type=row.querySelector('[data-key="type"]').value; const dur=parseFloat(row.querySelector('[data-key="dur"]').value)||1;
      customSteps[idx]={type,dur}; ls.save('custom_steps',customSteps);
    };
    controlsEl.addEventListener('input',e=>{ if(e.target.id==='loops') ls.save('custom_loops', +e.target.value||3); }, {once:true});
  } else {
    const row=document.createElement('div'); row.className='row';
    ui.forEach(def=>{
      const wrap=document.createElement('div'); wrap.className='control';
      wrap.innerHTML = `<label for="${def.id}">${def.label}</label>`;
      const inp=document.createElement('input'); inp.id=def.id; inp.type=def.type||'number';
      if(def.min!=null) inp.min=def.min; if(def.step!=null) inp.step=def.step;
      inp.setAttribute('inputmode',(def.step&&def.step%1!==0)?'decimal':'numeric');
      inp.value = ls.load(exId+'_'+def.id, def.default);
      inp.addEventListener('input',()=> ls.save(exId+'_'+def.id, +inp.value));
      wrap.appendChild(inp); row.appendChild(wrap);
    });
    controlsEl.appendChild(row);
  }
  renderStatusIdle();
}

/* ======= Status ======= */
function clearStatus(){ statusEl.innerHTML=''; }
function renderSeriesDots(n){
  const wrap=document.createElement('div'); wrap.className='progress';
  for(let i=0;i<n;i++){ const d=document.createElement('div'); d.className='dot'; wrap.appendChild(d); }
  statusEl.appendChild(wrap);
}
function markSeriesProgress(done){ const dots = statusEl.querySelectorAll('.dot'); dots.forEach((d,i)=> d.classList.toggle('done', i < done)); }
function renderTimer(total){
  const tb=document.createElement('div'); tb.className='timebar';
  const inner=document.createElement('div'); inner.className='timebar-inner'; inner.id='timebarInner';
  const txt=document.createElement('div'); txt.className='timebox'; txt.id='timebox'; txt.textContent=fmtTime(total);
  tb.appendChild(inner); statusEl.appendChild(txt); statusEl.appendChild(tb);
}
function updateTimerUI(){ if(!t0||!totalSec) return; const now=Date.now(), el=(now-t0)/1000, rem=Math.max(0,totalSec-el);
  const inner=document.getElementById('timebarInner'), txt=document.getElementById('timebox');
  if(inner) inner.style.width=`${Math.min(100, (el/totalSec)*100)}%`; if(txt) txt.textContent=fmtTime(rem);
}
function renderStatusIdle(){
  clearStatus(); const ex=exercises[exId];
  if(ex.mode==='series'){ const tgt=(document.getElementById('target')||document.getElementById('cycles')||document.getElementById('loops'));
    renderSeriesDots(tgt? Math.max(1, Math.floor(+tgt.value||1)) : 1);
  } else { const mins=document.getElementById('minutes'); renderTimer(((mins?+mins.value||5:5))*60); }
}

/* ======= Animations ======= */
let exId = ls.load('last_tab','free_timer');
let timeline=[], meta={}, totalSec=0, stepIdx=-1, stepDeadline=0, t0=0;
let timerId=null, tickId=null, audioCtx=null, paused=false, remainingSec=0;
let activeAnim=null, activeRingAnim=null;

function beep(freq, dur=200){
  if(muteToggle.checked) return;
  try{
    if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    const osc=audioCtx.createOscillator(), gain=audioCtx.createGain(); osc.type='sine'; osc.frequency.value=freq; osc.connect(gain); gain.connect(audioCtx.destination);
    const t=audioCtx.currentTime; gain.gain.setValueAtTime(0.0001,t); gain.gain.exponentialRampToValueAtTime(0.25,t+0.02);
    osc.start(t); gain.gain.exponentialRampToValueAtTime(0.0001,t+dur/1000); osc.stop(t+dur/1000+0.05);
  }catch(e){}
}
function hideRing(){ if(activeRingAnim){activeRingAnim.cancel(); activeRingAnim=null;} ring.style.opacity=0; const L=ringPath.getTotalLength(); ringPath.style.strokeDasharray=String(L); ringPath.style.strokeDashoffset=String(L); }
function drawRing(durationSec,startFraction=0){
  const L=ringPath.getTotalLength(); if(activeRingAnim){activeRingAnim.cancel();}
  ring.style.opacity=1; ringPath.style.strokeDasharray=String(L); ringPath.style.strokeDashoffset=String(L);
  activeRingAnim = ringPath.animate([{strokeDashoffset:L},{strokeDashoffset:0}],{duration:durationSec*1000,easing:'linear',fill:'forwards'});
  if(startFraction>0) activeRingAnim.currentTime=startFraction*durationSec*1000;
}
function drawBar(step, overrideDurSec=null, startFraction=0){
  const durSec=Math.max(0.1, overrideDurSec!=null?overrideDurSec:step.dur);
  fadeBgToPhase(step.type);
  if(activeAnim){activeAnim.cancel(); activeAnim=null;} hideRing();
  Object.assign(bar.style,{animation:'none',transition:'none',transform:'none',top:'auto',bottom:'auto',left:'auto',right:'auto',width:'4px',height:'4px'});
  if(exId==='box'){
    const seg = stepIdx % 4; let prop;
    if(seg===0){Object.assign(bar.style,{bottom:'0',left:'0',height:'4px'}); prop='width';}
    else if(seg===1){Object.assign(bar.style,{right:'0',bottom:'0',width:'4px'}); prop='height';}
    else if(seg===2){Object.assign(bar.style,{top:'0',right:'0',height:'4px',transform:'scaleX(-1)'}); prop='width';}
    else{Object.assign(bar.style,{top:'0',left:'0',width:'4px'}); prop='height';}
    activeAnim=bar.animate([{[prop]:'0%'},{[prop]:'100%'}],{duration:durSec*1000,easing:'linear',fill:'forwards'});
    if(startFraction>0) activeAnim.currentTime=startFraction*durSec*1000; return;
  }
  if(exId==='co2_hold' && step.type==='pause'){ drawRing(durSec,startFraction); return; }

  const relax=(exId==='relax_4_2_6');
  if(step.type==='inhale'){
    if(relax){ Object.assign(bar.style,{bottom:'0',left:'0',height:'4px'}); activeAnim=bar.animate([{width:'0%'},{width:'100%'}],{duration:durSec*1000,easing:'linear',fill:'forwards'}); }
    else { Object.assign(bar.style,{left:'0',bottom:'0',width:'100%'}); activeAnim=bar.animate([{height:'0%'},{height:'100%'}],{duration:durSec*1000,easing:'linear',fill:'forwards'}); }
  } else if(step.type==='exhale'){
    if(relax){ Object.assign(bar.style,{left:'0',bottom:'0',width:'100%',height:'100%'}); activeAnim=bar.animate([{height:'100%'},{height:'0%'}],{duration:durSec*1000,easing:'linear',fill:'forwards'}); }
    else { Object.assign(bar.style,{top:'0',right:'0',height:'4px',transform:'scaleX(-1)'}); activeAnim=bar.animate([{width:'0%'},{width:'100%'}],{duration:durSec*1000,easing:'linear',fill:'forwards'}); }
  } else if(step.type==='hold'){
    Object.assign(bar.style,{left:'0',bottom:'0',width:'100%'}); activeAnim=bar.animate([{height:'0%'},{height:'100%'}],{duration:durSec*1000,easing:'linear',fill:'forwards'});
  } else {
    Object.assign(bar.style,{bottom:'0',left:'0',height:'4px'}); activeAnim=bar.animate([{width:'0%'},{width:'100%'}],{duration:durSec*1000,easing:'linear',fill:'forwards'});
  }
  if(startFraction>0 && activeAnim) activeAnim.currentTime=startFraction*durSec*1000;
}

/* ======= Engine ======= */
function fmtTime(s){ s=Math.max(0,Math.round(s)); const m=Math.floor(s/60).toString(); const ss=(s%60).toString().padStart(2,'0'); return `${m}:${ss}`; }
function scheduleNext(){
  clearTimeout(timerId); const step=timeline[stepIdx]; if(!step){ stopCycle(); return; }
  stepDeadline = Date.now()+step.dur*1000; stepText.textContent = step.label;
  drawBar(step); beep(BEEP[step.type]||440);
  timerId = setTimeout(()=>advance(), step.dur*1000);
}
function advance(){
  stepIdx++; if(stepIdx>=timeline.length){ stopCycle(); return; }
  const ex=exercises[exId]; if(ex.mode==='series' && meta.cycleEnds){ const done=meta.cycleEnds.filter(i=>i<stepIdx).length; markSeriesProgress(done); }
  scheduleNext();
}
function readParams(){ const p={}; (exercises[exId].ui||[]).forEach(d=>{ const el=document.getElementById(d.id); if(el) p[d.id]=+el.value; }); if(exId==='custom'){ p.loops=+document.getElementById('loops').value||3; } return p; }
function startCycle(){
  const built = exercises[exId].buildTimeline(readParams()); timeline=built.steps; totalSec=built.totalSec; meta=built.meta||{};
  if(!timeline.length) return;
  stepIdx=-1; t0=Date.now(); startBtn.disabled=true; pauseBtn.disabled=false; pauseBtn.textContent='Pauza'; paused=false;
  statusEl.innerHTML=''; if(exercises[exId].mode==='series'){ renderSeriesDots(meta.target||1); markSeriesProgress(0); } else { renderTimer(totalSec); updateTimerUI(); }
  clearInterval(tickId); if(exercises[exId].mode!=='series'){ tickId=setInterval(updateTimerUI,250); }
  infoDetails.classList.remove('show'); document.body.classList.remove('dim');
  advance();
}
function stopCycle(){
  clearTimeout(timerId); clearInterval(tickId); if(activeAnim) activeAnim.cancel(); if(activeRingAnim) activeRingAnim.cancel(); hideRing();
  if(exercises[exId].mode==='series' && meta.target){ markSeriesProgress(meta.target); }
  stepText.textContent='Hotovo!'; startBtn.disabled=false; pauseBtn.disabled=true; paused=false;
}
function resetCycle(){
  clearTimeout(timerId); clearInterval(tickId); if(activeAnim) activeAnim.cancel(); if(activeRingAnim) activeRingAnim.cancel(); hideRing();
  startBtn.disabled=false; pauseBtn.disabled=true; paused=false; pauseBtn.textContent='Pauza';
  stepText.textContent='Připrav se'; t0=0; stepIdx=-1; timeline=[]; meta={}; totalSec=0; renderStatusIdle(); fadeBgToPhase('hold', true);
}
function pauseCycle(){
  if(!startBtn.disabled) return;
  if(paused){ resumeCycle(); return; }
  paused=true; pauseBtn.textContent='Pokračovat'; clearTimeout(timerId); if(tickId){clearInterval(tickId); tickId=null;}
  if(activeAnim) activeAnim.pause(); if(activeRingAnim) activeRingAnim.pause();
  remainingSec = Math.max(0, stepDeadline - Date.now())/1000;
}
function resumeCycle(){
  if(!paused) return; paused=false; pauseBtn.textContent='Pauza';
  if(activeAnim) activeAnim.play(); if(activeRingAnim) activeRingAnim.play();
  const rem=Math.max(0.05, remainingSec||0.05); stepDeadline=Date.now()+rem*1000; timerId=setTimeout(()=>advance(), rem*1000);
  if(exercises[exId].mode!=='series'){ tickId=setInterval(updateTimerUI,250); }
}

/* ======= Tabs logic + fades (swipe odstraněn) ======= */
function setExercise(id){
  if(!exercises[id]) return; exId=id; ls.save('last_tab',id);
  tabButtons.forEach(b=> b.setAttribute('aria-selected', b.dataset.id===id ? 'true':'false'));
  const sel = Array.from(tabButtons).find(b=>b.dataset.id===id); if(sel) sel.scrollIntoView({inline:'center',behavior:'smooth',block:'nearest'});
  resetCycle(); renderControls(); renderInfo(); updateTabFades();
}
function updateTabFades(){
  const sc = tabsEl;
  const hasLeft = sc.scrollLeft > 1;
  const hasRight = sc.scrollLeft + sc.clientWidth < sc.scrollWidth - 1;
  fadeL.classList.toggle('show', hasLeft);
  fadeR.classList.toggle('show', hasRight);
  tabsHint.classList.toggle('show', !hasLeft && hasRight);
}
tabsEl.addEventListener('scroll', updateTabFades, {passive:true});
window.addEventListener('resize', updateTabFades);
tabButtons.forEach(btn=> btn.addEventListener('click', ()=> setExercise(btn.dataset.id)) );

/* ======= Theme & init ======= */
function applyTheme(initial=false){
  if(initial){
    const saved=ls.load('theme',null); const sys=window.matchMedia('(prefers-color-scheme: dark)').matches;
    const dark = saved!=null ? saved : sys; document.body.classList.toggle('dark',dark); themeToggle.checked=dark;
  }else{ document.body.classList.toggle('dark', themeToggle.checked); ls.save('theme', themeToggle.checked); }
  fadeBgToPhase('hold', true);
}
themeToggle.addEventListener('change',()=>applyTheme());
muteToggle.addEventListener('change',()=> ls.save('mute', muteToggle.checked));

startBtn.addEventListener('click', startCycle);
resetBtn.addEventListener('click', resetCycle);
pauseBtn.addEventListener('click', ()=> (paused? resumeCycle(): pauseCycle()));

/* ======= Welcome onboarding (once) ======= */
const ONB_KEY='welcome_seen';
let slideIdx=0; const slides=[...slidesEl.querySelectorAll('.slide')];
function renderDots(){ dotsEl.innerHTML=''; slides.forEach((_,i)=>{ const b=document.createElement('b'); if(i===slideIdx) b.classList.add('active'); dotsEl.appendChild(b); }); }
function showSlide(i){
  slideIdx=Math.max(0,Math.min(i,slides.length-1));
  slides.forEach((s,idx)=> s.classList.toggle('show', idx===slideIdx));
  prevBtn.disabled = slideIdx===0;
  nextBtn.textContent = slideIdx===slides.length-1 ? 'Hotovo' : 'Další';
  renderDots();
}
function openWelcome(){ document.body.classList.add('onboard'); welcomeModal.classList.add('show'); showSlide(0); }
function closeWelcome(){ welcomeModal.classList.remove('show'); document.body.classList.remove('onboard'); ls.save(ONB_KEY,true); }
nextBtn.onclick = ()=>{ if(slideIdx===slides.length-1) closeWelcome(); else showSlide(slideIdx+1); };
prevBtn.onclick = ()=> showSlide(slideIdx-1);
skipBtn.onclick = closeWelcome;
helpLink.addEventListener('click',(e)=>{ e.preventDefault(); openWelcome(); });

/* ======= Init ======= */
applyTheme(true);
const savedMute = ls.load('mute',false); muteToggle.checked=!!savedMute;
bgA.classList.add('float'); bgB.classList.add('float'); bgA.style.opacity='0'; bgB.style.opacity='0'; activeBg=bgA; fadeBgToPhase('hold', true);

let exInit = ls.load('last_tab','free_timer'); if(!EX_ORDER.includes(exInit)) exInit='free_timer';
tabButtons.forEach(b=> b.setAttribute('aria-selected', b.dataset.id===exInit ? 'true':'false'));
exId=exInit; renderControls(); renderStatusIdle(); renderInfo(); updateTabFades();

// onboarding only once
if(!ls.load(ONB_KEY,false)) setTimeout(openWelcome, 150);

// auto-pause when hidden
document.addEventListener('visibilitychange', ()=>{ if(document.hidden && startBtn.disabled && !paused) pauseCycle();});
</script>
</body>
</html>
